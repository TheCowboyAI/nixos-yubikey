### Yubikey Initialization Process (Air-Gapped Environment)

This process outlines a secure method for creating and managing Yubikeys using a minimal, air-gapped environment. The goal is to generate keys that can be revoked, rotated, and shared among multiple Yubikeys while maintaining strong security. 

If you are deploying an Organization (or Family), we have a [structured solution](./organizationalkeys.md) to create Personal Yubikeys which are dependencies of an Organization Key.

Here’s a concise overview of what happens:

1. **Air-Gapped Setup**:  
   A bootable NixOS environment is created using an SD card or USB stick, ensuring the process is isolated from networks. The environment is minimal and designed solely for Yubikey initialization.

2. **Certify Key Creation**:  
   The Certify Key, stored on the Yubikey, is the master key used to generate subkeys. It is non-revocable, so once it’s destroyed, the Yubikey becomes unusable. Subkeys for various purposes (GPG, SSH, SSL) are generated by this master key.

3. **Subkeys for Use**:
   - **GPG Subkeys** for certification, encryption, signing, and authentication
   - **SSH Keypair** for secure shell authentication
   - **SSL Certificates**, including a Root CA and X.509 certificates for creating trusted, self-signed certificates

4. **Multiple Yubikeys**:  
   Keys can be duplicated across multiple Yubikeys. These devices share identical keys but remain distinguishable by their unique serial numbers. Keys can be backed up and stored in a secure location. This is not really necessary, but registering all 3 keys at once is necessary.

5. **Environment & Security**:
   After booting the secure environment, you set up environment variables, such as identity and key passphrases, and log the process for audit purposes. The log file and private keys can be encrypted and stored on the SD card.

6. **FIDO2 and TOTP**:  
   These additional authentication methods are supported, allowing for secure, passkey logins (FIDO2) and time-based one-time passwords (TOTP) with the Yubico Authenticator.

### Key Steps:
- Create air-gapped environment using NixOS.
- Create a Root CA for the Organization
- Initialize Organizational Level Yubikeys with a Root Certify Key.
- Generate revocable subkeys for GPG, SSH, and SSL usage.
- Generate a Wildcard SSL Certificate
- Initialize Individual Level Yubikeys with a Subordinate Key set that never leaves the device.
- Create an SSL Client Certificate for the Wildcard Certificate
- Back up private keys and store them securely.
- Register Yubikeys with identity and authentication services (FIDO2, TOTP).
- test all settings

This process ensures secure management and usage of Yubikeys, minimizing risks while allowing easy key rotation and recovery.


**[Guide](./doc/guide.md)**